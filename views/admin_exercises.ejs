<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üìù Aufgabenbereich - Admin Panel</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:0;background:#f5f5f5}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .card{background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:20px;margin-bottom:20px}
    .btn{display:inline-block;background:#007bff;color:#fff;padding:8px 14px;border-radius:6px;text-decoration:none;margin-right:8px;margin-bottom:8px}
    .btn-success{background:#28a745}
    .btn-warning{background:#ffc107;color:#000}
    .muted{color:#666}
    .pill{display:inline-block;padding:2px 10px;border-radius:14px;background:#e9ecef;margin-left:8px;font-weight:600}
    .exercises-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}
    .exercise-card{background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:20px;border-left:4px solid #28a745}
    .exercise-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .exercise-type{font-size:0.9em;color:#666;text-transform:uppercase}
    .exercise-question{font-weight:600;color:#333;margin-bottom:10px}
    .exercise-options{background:#f8f9fa;padding:10px;border-radius:5px;margin:10px 0}
    .exercise-answer{color:#28a745;font-weight:600}
    .exercise-explanation{color:#666;font-style:italic;margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="card">
      <h1>üìù Aufgabenbereich - √úbungen verwalten</h1>
      <p class="muted">Erstelle und verwalte interaktive √úbungen f√ºr deine Sch√ºler</p>
      <div>
        <a class="btn" href="/admin">‚¨ÖÔ∏è Zur√ºck zum Admin Panel</a>
        <a class="btn" href="/admin/content?password=test123">üìö Inhaltsverwaltung</a>
        <a class="btn" href="/dashboard/courses" target="_blank">üë®‚Äçüéì Sch√ºler-Interface testen</a>
      </div>
    </div>
    
    <!-- Neue √úbung erstellen -->
    <div class="card">
      <h3>üöÄ Neue √úbung erstellen</h3>
      <form id="exerciseForm">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div>
            <label><strong>Lektion ausw√§hlen:</strong></label>
            <select name="lesson_id" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;margin-top:5px">
              <% courses.forEach(course => { %>
                <optgroup label="<%= course.code %> - <%= course.title %>">
                  <% if (course.lessons && course.lessons.length > 0) { %>
                    <% course.lessons.forEach(lesson => { %>
                      <option value="<%= lesson.id %>"><%= lesson.title %></option>
                    <% }); %>
                  <% } else { %>
                    <option disabled>Keine Lektionen vorhanden</option>
                  <% } %>
                </optgroup>
              <% }); %>
            </select>
          </div>
          
          <div>
            <label><strong>Typ der √úbung:</strong></label>
            <select name="type" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;margin-top:5px">
              <option value="multiple_choice">Multiple Choice</option>
              <option value="fill_blank">L√ºckentext</option>
              <option value="true_false">Richtig/Falsch</option>
              <option value="matching">Zuordnung</option>
            </select>
          </div>
        </div>
        
        <div style="margin-top:20px">
          <label><strong>Frage:</strong></label>
          <textarea name="question" placeholder="Die Frage f√ºr die √úbung..." required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;margin-top:5px;min-height:80px"></textarea>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">
          <div>
            <label><strong>Antwortoptionen (JSON):</strong></label>
            <textarea name="options" placeholder='["Option A", "Option B", "Option C", "Option D"]' style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;margin-top:5px;min-height:80px"></textarea>
          </div>
          
          <div>
            <label><strong>Richtige Antwort:</strong></label>
            <input type="text" name="correct_answer" placeholder="Die richtige Antwort" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;margin-top:5px">
            
            <label style="margin-top:15px;display:block"><strong>Erkl√§rung:</strong></label>
            <textarea name="explanation" placeholder="Warum ist diese Antwort richtig?" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;margin-top:5px;min-height:60px"></textarea>
          </div>
        </div>
        
        <button type="submit" class="btn btn-success" style="margin-top:20px">‚úÖ √úbung erstellen</button>
      </form>
    </div>
    
    <!-- Bestehende √úbungen anzeigen -->
    <div class="card">
      <h3>üìã Bestehende √úbungen</h3>
      <% if (courses.length === 0) { %>
        <p class="muted">Noch keine Kurse vorhanden. Erstelle zuerst Kurse und Lektionen.</p>
      <% } else { %>
        <div class="exercises-grid">
          <% courses.forEach(course => { %>
            <% if (course.lessons && course.lessons.length > 0) { %>
              <% course.lessons.forEach(lesson => { %>
                <% if (lesson.exercises && lesson.exercises.length > 0) { %>
                  <% lesson.exercises.forEach(exercise => { %>
                    <div class="exercise-card">
                      <div class="exercise-header">
                        <span class="pill"><%= course.code %></span>
                        <span class="exercise-type"><%= exercise.type %></span>
                      </div>
                      <div class="exercise-question"><%= exercise.question %></div>
                      
                      <% if (exercise.options && exercise.options.length > 0) { %>
                        <div class="exercise-options">
                          <strong>Optionen:</strong><br>
                          <% exercise.options.forEach((option, index) => { %>
                            <span class="pill" style="margin:2px;display:inline-block"><%= option %></span>
                          <% }); %>
                        </div>
                      <% } %>
                      
                      <div class="exercise-answer">‚úÖ Richtige Antwort: <%= exercise.correct_answer %></div>
                      
                      <% if (exercise.explanation) { %>
                        <div class="exercise-explanation">üí° <%= exercise.explanation %></div>
                      <% } %>
                    </div>
                  <% }); %>
                <% } %>
              <% }); %>
            <% } %>
          <% }); %>
        </div>
        
        <% 
          let totalExercises = 0;
          courses.forEach(course => {
            if (course.lessons) {
              course.lessons.forEach(lesson => {
                if (lesson.exercises) {
                  totalExercises += lesson.exercises.length;
                }
              });
            }
          });
        %>
        
        <% if (totalExercises === 0) { %>
          <p class="muted">Noch keine √úbungen vorhanden. Erstelle welche √ºber das Formular oben.</p>
        <% } else { %>
          <p class="muted">Gesamt: <%= totalExercises %> √úbungen in <%= courses.length %> Kursen</p>
        <% } %>
      <% } %>
    </div>
    
    <!-- √úbungstypen Info -->
    <div class="card">
      <h3>üí° √úbungstypen erkl√§rt</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px">
        <div>
          <h4>üîò Multiple Choice</h4>
          <p>Sch√ºler w√§hlen aus mehreren vorgegebenen Antworten die richtige aus.</p>
          <p class="muted">Beispiel: "Welcher Buchstabe kommt nach A?" ‚Üí [B, C, D, E]</p>
        </div>
        <div>
          <h4>‚¨ú L√ºckentext</h4>
          <p>Sch√ºler f√ºllen fehlende W√∂rter oder Buchstaben in einem Text ein.</p>
          <p class="muted">Beispiel: "Das deutsche ___ hat 26 Buchstaben." ‚Üí "Alphabet"</p>
        </div>
        <div>
          <h4>‚úÖ Richtig/Falsch</h4>
          <p>Sch√ºler bewerten Aussagen als richtig oder falsch.</p>
          <p class="muted">Beispiel: "Deutsch hat 30 Buchstaben." ‚Üí Falsch</p>
        </div>
        <div>
          <h4>üîó Zuordnung</h4>
          <p>Sch√ºler ordnen Begriffe oder S√§tze einander zu.</p>
          <p class="muted">Beispiel: "Hallo" ‚Üî "Begr√º√üung"</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // √úbung erstellen
    document.getElementById('exerciseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      data.lesson_id = parseInt(data.lesson_id);
      
      // JSON f√ºr options parsen
      try {
        data.options = JSON.parse(data.options);
      } catch {
        data.options = [];
      }
      
      try {
        const response = await fetch('/admin/content/exercises', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
          alert('‚úÖ √úbung erfolgreich erstellt!');
          location.reload();
        } else {
          alert('‚ùå Fehler: ' + result.error);
        }
      } catch (error) {
        alert('‚ùå Fehler beim Erstellen der √úbung');
      }
    });
  </script>
</body>
</html>
